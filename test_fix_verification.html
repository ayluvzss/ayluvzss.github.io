<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日期修复验证测试</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .daily-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        #dailyPrev, #dailyNext {
            padding: 5px 10px;
            font-size: 18px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        #dailyDateTitle {
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>日期修复验证测试</h1>
    
    <div class="test-section">
        <h2>测试1：日期切换功能</h2>
        <div class="daily-header">
            <button id="dailyPrev">▲</button>
            <span id="dailyDateTitle"></span>
            <button id="dailyNext">▼</button>
        </div>
        <div id="test1-result" class="test-result">测试进行中...</div>
    </div>
    
    <div class="test-section">
        <h2>测试2：状态一致性</h2>
        <p>当前应用状态日期：<span id="appStateDate"></span></p>
        <p>当前DOM显示日期：<span id="domDate"></span></p>
        <div id="test2-result" class="test-result">测试进行中...</div>
    </div>
    
    <div class="test-section">
        <h2>测试3：多轮切换测试</h2>
        <button onclick="runMultipleTests()">运行多轮切换测试</button>
        <div id="test3-result" class="test-result">测试未开始...</div>
    </div>

    <script>
        // 模拟修复后的appState
        let appState = {
            currentDailyDate: null
        };
        
        // DOM元素
        const DOM = {
            dailyPrev: document.getElementById('dailyPrev'),
            dailyNext: document.getElementById('dailyNext'),
            dailyDateTitle: document.getElementById('dailyDateTitle')
        };
        
        // 辅助函数
        function formatDate(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        
        function formatDateForDisplay(dateStr) {
            const date = new Date(dateStr);
            return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日`;
        }
        
        function isFutureDate(d) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return d > today;
        }
        
        // 更新日期标题
        function updateDailyDateTitle() {
            if (DOM.dailyDateTitle && appState.currentDailyDate) {
                DOM.dailyDateTitle.innerText = formatDateForDisplay(appState.currentDailyDate);
            }
        }
        
        // 加载每日记录（模拟）
        function loadDailyNotes() {
            console.log('加载日期数据:', appState.currentDailyDate);
        }
        
        // 初始化
        function init() {
            // 设置当前日期
            const today = new Date();
            appState.currentDailyDate = formatDate(today);
            updateDailyDateTitle();
            
            // 绑定事件监听器（修复后的版本）
            if (DOM.dailyPrev) {
                DOM.dailyPrev.addEventListener('click', () => {
                    const prevDate = new Date(appState.currentDailyDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    appState.currentDailyDate = formatDate(prevDate);
                    updateDailyDateTitle();
                    loadDailyNotes();
                    updateTest2();
                });
            }

            if (DOM.dailyNext) {
                DOM.dailyNext.addEventListener('click', () => {
                    const nextDate = new Date(appState.currentDailyDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    // 不能查看未来日期
                    if (!isFutureDate(nextDate)) {
                        appState.currentDailyDate = formatDate(nextDate);
                        updateDailyDateTitle();
                        loadDailyNotes();
                        updateTest2();
                    }
                });
            }
            
            // 初始化测试
            updateTest2();
        }
        
        // 测试2：更新状态显示
        function updateTest2() {
            const appStateDateEl = document.getElementById('appStateDate');
            const domDateEl = document.getElementById('domDate');
            const resultEl = document.getElementById('test2-result');
            
            if (appStateDateEl && domDateEl) {
                appStateDateEl.innerText = appState.currentDailyDate;
                domDateEl.innerText = DOM.dailyDateTitle ? DOM.dailyDateTitle.innerText : '未找到元素';
                
                // 验证一致性
                const appStateDate = new Date(appState.currentDailyDate);
                const domDateStr = DOM.dailyDateTitle ? DOM.dailyDateTitle.innerText : '';
                const domDateMatch = domDateStr.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
                
                if (domDateMatch) {
                    const domDate = new Date(domDateMatch[1], domDateMatch[2]-1, domDateMatch[3]);
                    const isConsistent = appStateDate.toDateString() === domDate.toDateString();
                    
                    if (isConsistent) {
                        resultEl.className = 'test-result pass';
                        resultEl.innerText = '✓ 状态一致：appState.currentDailyDate 与 DOM 显示的日期匹配';
                    } else {
                        resultEl.className = 'test-result fail';
                        resultEl.innerText = '✗ 状态不一致：appState.currentDailyDate 与 DOM 显示的日期不匹配';
                    }
                } else {
                    resultEl.className = 'test-result fail';
                    resultEl.innerText = '✗ 无法解析 DOM 显示的日期格式';
                }
            }
        }
        
        // 测试3：多轮切换测试
        function runMultipleTests() {
            const resultEl = document.getElementById('test3-result');
            resultEl.className = 'test-result';
            resultEl.innerText = '测试进行中...';
            
            let testCount = 10; // 运行10轮测试
            let passCount = 0;
            
            // 保存初始日期
            const initialDate = new Date(appState.currentDailyDate);
            
            function runNextTest(index) {
                if (index >= testCount) {
                    // 测试完成
                    if (passCount === testCount) {
                        resultEl.className = 'test-result pass';
                        resultEl.innerText = `✓ 所有${testCount}轮测试通过！日期显示始终保持一致。`;
                    } else {
                        resultEl.className = 'test-result fail';
                        resultEl.innerText = `✗ ${passCount}/${testCount}轮测试通过。存在日期显示不一致的情况。`;
                    }
                    // 恢复初始日期
                    appState.currentDailyDate = formatDate(initialDate);
                    updateDailyDateTitle();
                    updateTest2();
                    return;
                }
                
                // 随机选择上一个或下一个日期
                const action = Math.random() > 0.5 ? 'prev' : 'next';
                const prevStateDate = new Date(appState.currentDailyDate);
                
                if (action === 'prev') {
                    const prevDate = new Date(appState.currentDailyDate);
                    prevDate.setDate(prevDate.getDate() - 1);
                    appState.currentDailyDate = formatDate(prevDate);
                } else {
                    const nextDate = new Date(appState.currentDailyDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    if (!isFutureDate(nextDate)) {
                        appState.currentDailyDate = formatDate(nextDate);
                    }
                }
                
                updateDailyDateTitle();
                
                // 验证一致性
                const appStateDate = new Date(appState.currentDailyDate);
                const domDateStr = DOM.dailyDateTitle ? DOM.dailyDateTitle.innerText : '';
                const domDateMatch = domDateStr.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
                
                if (domDateMatch) {
                    const domDate = new Date(domDateMatch[1], domDateMatch[2]-1, domDateMatch[3]);
                    const isConsistent = appStateDate.toDateString() === domDate.toDateString();
                    
                    if (isConsistent) {
                        passCount++;
                    }
                }
                
                // 延迟运行下一轮测试
                setTimeout(() => runNextTest(index + 1), 100);
            }
            
            // 开始测试
            runNextTest(0);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>